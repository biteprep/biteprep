{% extends "base.html" %}
{% block title %}SJT Mock Exam In Progress{% endblock %}

{% block head_styles %}
<style>
    /* Styles for SortableJS/Ranking */
    .sortable-list {
        list-style-type: none;
        padding-left: 0;
    }
    .sortable-item {
        cursor: move;
        padding: 10px 15px;
        margin-bottom: 5px;
        border: 1px solid var(--bs-border-color);
        background-color: var(--bs-body-bg);
        border-radius: 0.25rem;
        transition: background-color 0.2s;
    }
    .sortable-item:hover {
        background-color: var(--bs-tertiary-bg);
    }
    .sortable-ghost {
        opacity: 0.4;
        border: 2px dashed var(--bs-primary);
    }
    /* Hide navigation during exam for focus */
    .navbar, .footer {
        display: none !important;
    }
    body {
        padding-top: 60px; /* Space for the fixed timer bar */
    }
    .content-container {
        margin-top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
{# Exam Header Bar #}
<div class="fixed-top bg-body-tertiary border-bottom p-2 shadow-sm" style="z-index: 1030;">
    <div class="d-flex justify-content-between align-items-center px-3">
        <h5>SJT Mock Exam</h5>
        <div id="timer" class="badge bg-secondary fs-5">Time Left: --:--</div>
        <button class="btn btn-outline-primary" onclick="showNavigator()">Navigator</button>
    </div>
</div>

{# Main Exam Container #}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div id="question-container">
            <!-- Questions will be loaded here by JavaScript -->
        </div>

        <div class="d-flex justify-content-between mt-4 mb-5">
            <button id="prev-btn" class="btn btn-outline-secondary" onclick="changeQuestion(-1)" disabled>← Previous</button>
            <button id="next-btn" class="btn btn-primary" onclick="changeQuestion(1)">Next →</button>
            <button id="finish-btn" class="btn btn-success" style="display: none;" onclick="confirmFinishExam()">Finish Exam</button>
        </div>
    </div>
</div>

<!-- Navigator Modal -->
<div class="modal fade" id="navigatorModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Exam Navigator</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Green indicates answered questions.</p>
        <div id="navigator-grid" class="d-flex flex-wrap">
            <!-- Buttons generated by JS -->
        </div>
      </div>
        <div class="modal-footer">
             <button class="btn btn-danger" onclick="confirmFinishExam()">Finish and Submit Exam</button>
        </div>
    </div>
  </div>
</div>

<!-- Include SortableJS from CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
    // Initialize data from Django context
    const questions = {{ questions_data|safe }};
    const totalQuestions = questions.length;
    let currentQuestionIndex = 0;
    let userAnswers = {{ user_answers|safe }};
    let secondsRemaining = {{ seconds_remaining }};
    const submitUrl = "{% url 'sjt_prep:submit_sjt_answers' %}";
    const csrfToken = "{{ csrf_token }}";

    // --- Timer Logic ---
    function updateTimer() {
        if (secondsRemaining <= 0) {
            clearInterval(timerInterval);
            // The backend handles the redirect when time is up, but we force it here for immediate feedback
            alert("Time is up! The exam will now be submitted.");
            finishExam();
            return;
        }
        secondsRemaining--;
        const minutes = Math.floor(secondsRemaining / 60);
        const seconds = secondsRemaining % 60;
        document.getElementById('timer').textContent = `Time Left: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        
        if (secondsRemaining < 300) { // Less than 5 minutes
             document.getElementById('timer').classList.remove('bg-secondary');
             document.getElementById('timer').classList.add('bg-danger');
        }
    }
    const timerInterval = setInterval(updateTimer, 1000);

    // --- Rendering Logic ---
    function renderQuestion() {
        const container = document.getElementById('question-container');
        const question = questions[currentQuestionIndex];
        
        let html = `<div class="card shadow-sm">
            <div class="card-header">Question ${currentQuestionIndex + 1} of ${totalQuestions}</div>
            <div class="card-body">
                <p><strong>Scenario:</strong></p>
                <p class="alert alert-info">${question.scenario.replace(/\n/g, '<br>')}</p>
                <hr>`;

        if (question.type === 'ranking') {
            html += renderRanking(question);
        } else if (question.type === 'mcq') {
            html += renderMCQ(question);
        }

        html += `</div></div>`;
        container.innerHTML = html;

        // Initialize SortableJS only for ranking questions
        if (question.type === 'ranking') {
            initializeSortable(question.index);
        }
        
        updateNavigationButtons();
        updateNavigator();
    }

    function renderRanking(question) {
        let html = `<p><em>Rank the following actions from Most Appropriate (Top) to Least Appropriate (Bottom). Drag and drop to reorder.</em></p>`;
        html += `<ul id="sortable-${question.index}" class="sortable-list">`;
        
        // Check if there's a saved answer and reorder the actions array accordingly
        const savedOrder = userAnswers[question.index] || [];
        let actionsToRender = [...question.actions];

        if (savedOrder.length > 0) {
            // Sort the actions based on the order stored in savedOrder
            actionsToRender.sort((a, b) => {
                // IDs are stored as strings in userAnswers
                return savedOrder.indexOf(String(a.id)) - savedOrder.indexOf(String(b.id));
            });
        }

        actionsToRender.forEach(action => {
            // Added grip icon for better UX
            html += `<li class="sortable-item" data-id="${action.id}"><i class="bi bi-grip-vertical me-2 text-muted"></i>${action.text}</li>`;
        });
        html += `</ul>`;
        return html;
    }

    function renderMCQ(question) {
        let html = `<p><em>Select the <strong>THREE</strong> most appropriate actions.</em></p>`;
        html += `<div class="list-group" id="mcq-${question.index}">`;
        
        // Check for previously saved selections
        const savedSelections = userAnswers[question.index] || [];

        question.actions.forEach(action => {
            // IDs are stored as strings in userAnswers
            const checked = savedSelections.includes(String(action.id)) ? 'checked' : '';
            html += `<label class="list-group-item list-group-item-action">
                        <input class="form-check-input me-2 mcq-checkbox" type="checkbox" value="${action.id}" ${checked} onchange="handleMCQChange(${question.index}, event)">
                        ${action.text}
                     </label>`;
        });
        html += `</div>`;
        return html;
    }

    // --- Interaction Handlers ---

    function initializeSortable(index) {
        const el = document.getElementById(`sortable-${index}`);
        Sortable.create(el, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: () => saveAnswers(index) // Save when dragging stops
        });
    }

    function handleMCQChange(index, event) {
        const checkboxes = document.querySelectorAll(`#mcq-${index} .mcq-checkbox`);
        const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;

        // Enforce the limit of 3 selections
        if (checkedCount > 3) {
            alert("You cannot select more than 3 options.");
            event.target.checked = false; // Uncheck the one that exceeded the limit
        } else {
            saveAnswers(index);
        }
    }

    // --- State Management ---

    function saveAnswers(index) {
        const question = questions[index];
        let answers = [];

        if (question.type === 'ranking') {
            const listItems = document.querySelectorAll(`#sortable-${index} .sortable-item`);
            answers = Array.from(listItems).map(item => item.getAttribute('data-id'));
        } else if (question.type === 'mcq') {
            const checkedBoxes = document.querySelectorAll(`#mcq-${index} .mcq-checkbox:checked`);
            answers = Array.from(checkedBoxes).map(cb => cb.value);
        }

        userAnswers[index] = answers;
        updateNavigator(); // Update navigator color immediately
        // Persist to backend via AJAX
        persistAnswers(index, answers);
    }

    function persistAnswers(index, answers) {
        const formData = new FormData();
        formData.append('q_index', index);
        // Append list items correctly for Django backend
        answers.forEach(answer => formData.append('answers[]', answer));
        formData.append('csrfmiddlewaretoken', csrfToken);

        fetch(submitUrl, {
            method: 'POST',
            body: formData,
            headers: {'X-Requested-With': 'XMLHttpRequest'} 
        })
        .then(response => response.json())
        .then(data => {
            if (data.status !== 'success') {
                console.error('Failed to save answer:', data.message);
            }
        })
        .catch(error => console.error('Error saving answer:', error));
    }

    function changeQuestion(direction) {
        const newIndex = currentQuestionIndex + direction;
        if (newIndex >= 0 && newIndex < totalQuestions) {
            currentQuestionIndex = newIndex;
            renderQuestion();
        }
    }

    function jumpToQuestion(index) {
        currentQuestionIndex = index;
        renderQuestion();
        // Close the modal after jumping
        const modalEl = document.getElementById('navigatorModal');
        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        modal.hide();
    }

    function updateNavigationButtons() {
        document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
        const isLast = currentQuestionIndex === totalQuestions - 1;
        document.getElementById('next-btn').style.display = isLast ? 'none' : 'block';
        document.getElementById('finish-btn').style.display = isLast ? 'block' : 'none';
    }

    // --- Navigator ---
    function updateNavigator() {
        const grid = document.getElementById('navigator-grid');
        // Initialize buttons if they don't exist
        if (grid.children.length === 0) {
             questions.forEach((q, index) => {
                const btn = document.createElement('button');
                btn.style = "width: 45px; height: 45px;";
                btn.textContent = index + 1;
                btn.onclick = () => jumpToQuestion(index);
                btn.id = `nav-btn-${index}`;
                grid.appendChild(btn);
            });
        }

        // Update classes based on answer status
         questions.forEach((q, index) => {
            const btn = document.getElementById(`nav-btn-${index}`);
            const answered = userAnswers[index] && userAnswers[index].length > 0;
            let btnClass = answered ? 'btn-success' : 'btn-outline-secondary';
            
            if (index === currentQuestionIndex) {
                btnClass = btnClass.replace('btn-outline-', 'btn-') + ' active';
            }
            btn.className = `btn ${btnClass} me-1 mb-1`;
         });
    }

    function showNavigator() {
        const modalEl = document.getElementById('navigatorModal');
        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        modal.show();
    }

    function confirmFinishExam() {
        if (confirm("Are you sure you want to finish and submit the exam?")) {
            finishExam();
        }
    }

    function finishExam() {
        // Redirect to the results page. The backend handles final scoring based on the session.
        window.location.href = "{% url 'sjt_prep:sjt_results' %}";
    }

    // Initialize the player
    document.addEventListener('DOMContentLoaded', () => {
        updateTimer(); // Start the timer visually immediately
        renderQuestion();
    });
</script>
{% endblock %}