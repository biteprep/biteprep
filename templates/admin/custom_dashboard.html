{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .stat-card h3 {
        margin: 0 0 10px 0;
        color: #666;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #333;
    }
    
    .stat-change {
        font-size: 12px;
        margin-top: 5px;
    }
    
    .stat-change.positive { color: #10b981; }
    .stat-change.negative { color: #ef4444; }
    
    .card-primary { border-left: 4px solid #3b82f6; }
    .card-success { border-left: 4px solid #10b981; }
    .card-warning { border-left: 4px solid #f59e0b; }
    .card-danger { border-left: 4px solid #ef4444; }
    
    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .quick-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }
    
    .quick-action-btn {
        padding: 10px 20px;
        background: #3b82f6;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 500;
        transition: background 0.2s;
    }
    
    .quick-action-btn:hover {
        background: #2563eb;
        color: white;
    }
    
    .activity-list {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .activity-item {
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .activity-item:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
<h1>Admin Dashboard</h1>

<div class="quick-actions">
    <a href="{% url 'admin:bulk_upload' %}" class="quick-action-btn">
        ðŸ“¤ Bulk Upload Questions
    </a>
    <a href="{% url 'admin:security_dashboard' %}" class="quick-action-btn">
        ðŸ”’ Security Monitor
    </a>
    <a href="{% url 'admin:export_data' 'users' %}" class="quick-action-btn">
        ðŸ“Š Export Users
    </a>
    <a href="{% url 'admin:export_data' 'questions' %}" class="quick-action-btn">
        ðŸ“Š Export Questions
    </a>
</div>

<div class="dashboard-grid">
    <div class="stat-card card-primary">
        <h3>Total Users</h3>
        <div class="stat-value">{{ total_users|floatformat:0 }}</div>
        <div class="stat-change positive">+{{ new_this_week }} this week</div>
    </div>
    
    <div class="stat-card card-success">
        <h3>Active Subscriptions</h3>
        <div class="stat-value">{{ active_subscriptions }}</div>
        <div class="stat-change">MRR: Â£{{ mrr|floatformat:2 }}</div>
    </div>
    
    <div class="stat-card card-warning">
        <h3>Live Questions</h3>
        <div class="stat-value">{{ live_questions }}</div>
        <div class="stat-change">{{ draft_questions }} drafts</div>
    </div>
    
    <div class="stat-card card-danger">
        <h3>Needs Review</h3>
        <div class="stat-value">{{ questions_need_review }}</div>
        <div class="stat-change">Question reports</div>
    </div>
    
    <div class="stat-card">
        <h3>Active Today</h3>
        <div class="stat-value">{{ active_today }}</div>
        <div class="stat-change">Users</div>
    </div>
    
    <div class="stat-card">
        <h3>Avg Score</h3>
        <div class="stat-value">{{ avg_score_percentage|floatformat:1 }}%</div>
        <div class="stat-change">Platform average</div>
    </div>
</div>

<div class="chart-container">
    <h2>Activity Trend (Last 30 Days)</h2>
    <canvas id="activityChart" height="80"></canvas>
</div>

<div class="dashboard-grid">
    <div class="activity-list">
        <h3>Recent Users</h3>
        {% for user in recent_users %}
        <div class="activity-item">
            <strong>{{ user.username }}</strong><br>
            <small>{{ user.date_joined|timesince }} ago</small>
        </div>
        {% endfor %}
    </div>
    
    <div class="activity-list">
        <h3>Open Reports</h3>
        {% for report in recent_reports %}
        <div class="activity-item">
            <strong>Q{{ report.question.id }}</strong><br>
            <small>{{ report.reason|truncatechars:50 }}</small>
        </div>
        {% empty %}
        <p>No open reports</p>
        {% endfor %}
    </div>
    
    <div class="activity-list">
        <h3>Difficult Questions</h3>
        {% for question in difficult_questions %}
        <div class="activity-item">
            <strong>{{ question.question_text|truncatechars:50 }}</strong><br>
            <small>Success rate: {{ question.success_rate|floatformat:1 }}%</small>
        </div>
        {% endfor %}
    </div>
</div>

<!-- FIX: Use json_script to safely serialize data for JavaScript instead of |safe -->
<!-- This renders a <script type="application/json" id="chart-data-json">...</script> block -->
{{ chart_data|json_script:"chart-data-json" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // FIX: Parse the data from the json_script tag.
    // Use DOMContentLoaded to ensure the DOM is ready before accessing elements.
    document.addEventListener('DOMContentLoaded', function() {
        const chartDataElement = document.getElementById('chart-data-json');
        
        if (!chartDataElement) {
            console.error("Chart data element not found.");
            return;
        }
        
        try {
            // Parse the safely serialized JSON data
            const chartData = JSON.parse(chartDataElement.textContent);
            const ctx = document.getElementById('activityChart').getContext('2d');
            
            // Initialize the chart.
            // We use traditional functions (ES5) for .map() just in case the linter is very strict.
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(function(d) { return d.date; }),
                    datasets: [{
                        label: 'New Users',
                        data: chartData.map(function(d) { return d.users; }),
                        borderColor: '#3b82f6',
                        tension: 0.1
                    }, {
                        label: 'Answers',
                        data: chartData.map(function(d) { return d.answers; }),
                        borderColor: '#10b981',
                        tension: 0.1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'New Users'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Answers'
                            },
                            grid: {
                                drawOnChartArea: false, // Prevents secondary axis grid lines from overlapping
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error("Error initializing chart or parsing data:", error);
        }
    });
</script>
{% endblock %}